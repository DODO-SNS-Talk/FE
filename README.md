## <img src="https://user-images.githubusercontent.com/119986005/224246864-4455d2db-05b4-4ffb-95d9-cd58196d58f6.png" width="30" height="30"/> Dorun Dorun

<img src="https://user-images.githubusercontent.com/119986005/224254036-b640b29d-c78e-44bc-9eb5-f24609b2585c.png" width="600px" height="340px" max-width="100%"/>

<br>

## <img src="https://user-images.githubusercontent.com/119986005/224265413-251c74ca-31c5-4669-b3d6-03464cf343e4.png" width="40" height="40"/> 두런두런 소개

➊. 같은 관심사와 목표를 공유하는 친구들을 만나 즐겁게 소통하고

➋. 특별하게 기록할 수 있는 새로운 방법을 만나보세요 ✿∘˚˳°∘°

<br>

## <img src="https://user-images.githubusercontent.com/119986005/224248700-28e1011e-43d6-4cef-a44a-47a1bb29d1b0.png" width="40" height="40"/> 바로가기

- 사이트 바로가기 : https://dorun-dorun.vercel.app/
- 프론트엔드 GitHub Repository :https://github.com/DorunDorun/FE
- 백엔드 GitHub Respository : https://github.com/DorunDorun/BE

<br>

## <img src="https://user-images.githubusercontent.com/119986005/224263096-ee149a94-41bd-4b57-97e5-83a5959d7415.png" width="40" height="40"/> 프로젝트 기간

> 2023.02.02 ~2023.03.15 (6주)

<br>

## <img src="https://user-images.githubusercontent.com/119986005/224251778-c288a047-1d82-4b9b-abe9-c78268403e34.png" width="40" height="40"/> MEMBERS

| <img src="https://user-images.githubusercontent.com/119986005/224254750-51511609-d725-4f0b-b3c7-714f04e0a743.png" width="40" height="40"/> | <img src="https://user-images.githubusercontent.com/119986005/224254783-87a64b9f-2433-46fd-93d9-ca02a1ee5b5a.png" width="40" height="40"/> | <img src="https://user-images.githubusercontent.com/119986005/224254792-e384f247-0396-4056-a9a2-058e37e51e2e.png" width="40" height="40"/> | <img src="https://user-images.githubusercontent.com/119986005/224254798-a05ba1e4-9209-4e6c-b740-7b2d38f8cae4.png" width="40" height="40"/> | <img src="https://user-images.githubusercontent.com/119986005/224254811-54b82b29-586c-4e3f-822d-60b953cd8c2a.png" width="40" height="40"/> |
| :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: | :----------------------------------------------------------------------------------------------------------------------------------------: |
|                                                                   황현준                                                                   |                                                                   박관우                                                                   |                                                                   김준철                                                                   |                                                                   박청우                                                                   |                                                                   우채윤                                                                   |
|                                                                  Backend                                                                   |                                                                  Backend                                                                   |                                                                  Frontend                                                                  |                                                                  Frontend                                                                  |                                                                  Designer                                                                  |
|                                               [github](https://github.com/hyunjunhwang1994)                                                |                                                   [github](https://github.com/dirn0568)                                                    |                                                    [github](https://github.com/IOTrue)                                                     |                                                    [github](https://github.com/cheongu)                                                    |                                                                                                                                            |

<br >

**황현준**

<details><summary>기능
</summary>
<br >
<img src="https://user-images.githubusercontent.com/119986005/224261464-df15f6f9-1138-41c0-a348-2357a180d8a4.png" width="30" height="30"/> 기능

- Media Server(Openvidu) 구축 관리

- 화상 채팅
- 소셜 로그인 (Security + OAuth2 + JWT)

</details>

<br />

**박관우**

<details><summary>기능
</summary>
<br >
<img src="https://user-images.githubusercontent.com/119986005/224261464-df15f6f9-1138-41c0-a348-2357a180d8a4.png" width="30" height="30"/> 기능

- WebSocket

- API 서버
- SSE
- Redis, 로그 관리
- Prometheus
- Grafana

</details>

<br />

**김준철**

<details><summary>페이지 / 기능
</summary>
<br >
<img src="https://user-images.githubusercontent.com/119986005/224261892-7edc3392-70a4-4582-828e-d8fc2e003245.png" width="30" height="30"/>  페이지

- RoomList 페이지

- 화상채팅방 페이지
- RoomCreate 페이지
- RoomWaiting 페이지

<img src="https://user-images.githubusercontent.com/119986005/224259404-dec9d4c9-fa5a-4a95-ba96-2952cd5d551f.png" width="30" height="30"/> 기능

- webRTC

- canvas
- display capture
- 무한 스크롤
- 검색
- 초대하기(카카오톡)

</details>

<br />

**박청우**

<details><summary>페이지 / 기능
</summary>
<br >
<img src="https://user-images.githubusercontent.com/119986005/224261892-7edc3392-70a4-4582-828e-d8fc2e003245.png" width="30" height="30"/>  페이지

- 화상방(채팅)

- 로그인
- 랜딩페이지
- About페이지

<img src="https://user-images.githubusercontent.com/119986005/224259404-dec9d4c9-fa5a-4a95-ba96-2952cd5d551f.png" width="30" height="30"/> 기능

- 텍스트 채팅

  > `소켓연결, 나가기/새로고침 소켓 연결해제, 이미지 전송`

- 소셜로그인

  > `구글/카카오/네이버 소셜로그인, 로그아웃`

- 랜딩페이지
  > `sse 현재 생성된 방의 총 개수, 지금까지 생성된 방 개수, 지금까지 진행된 라이브 총 시간`

> > _etc_ > > `헤더, 마이페이지, 사이드바`

</details>

<br />

## <img src="https://user-images.githubusercontent.com/119986005/224386396-7b3fbeec-c20a-42a7-95de-17a34991d56d.png" width="40" height="40"/> 두런두런 서비스 화면

<br />

<p aligh="center">

**방목록~검색**

 <br />
 <img src="https://user-images.githubusercontent.com/119986005/225036356-67f5e44d-a7cc-49ff-b6f0-c570d1807d3f.gif"></p>
<br />

<p aligh="center">

**방생성~입장**

 <br />
 <img src="https://user-images.githubusercontent.com/119986005/225036385-ac499a75-d6f7-4bcc-a526-6abd4cd48694.gif"></p>
<br />

<p aligh="center">

**방초대-참여자-입장**

 <br />
 <img src="https://user-images.githubusercontent.com/119986005/225036393-79aea9a4-e796-44f5-9c94-929729aba836.gif"></p>
<br />

<p aligh="center">

**채팅방 기능**

 <br />
 <img src="https://user-images.githubusercontent.com/119986005/225043932-3f8946bf-f289-48d6-8921-6a0a05fd82b1.gif"></p>
<br />

## <img src="https://user-images.githubusercontent.com/119986005/224274030-3075300c-3e32-4090-b88d-246d52e04169.png" width="40" height="40"/> 두런두런 서비스 주요기능

<img src="https://user-images.githubusercontent.com/119986005/224270908-b0b55069-68fa-47bf-9aa9-94f8f530c6c4.png" width="30" height="30"/> **같은 관심사, 목표를 가진 사람들을 만나 “두런두런” 대화할 수 있어요**

- 공부, 재테크, 직장, 친목, 취미, 운동 6가지 카테고리 중에서 나의 관심사에 맞는 방에 참여해보세요

<img src="https://user-images.githubusercontent.com/119986005/224272370-8b6bc00e-6bcd-4d5c-8608-d9461adab718.png" width="30" height="30"/> **나만의 라이브 룸 환경을 조성할 수 있어요**

- 라이브 룸 배경을 나만의 감성으로 꾸미고 나만의 환경에 몰입해 보세요

<img src="https://user-images.githubusercontent.com/119986005/224269896-f2c0022d-43bd-4889-9e44-579f6c7d90ac.png" width="30" height="30"/> **친구들과 함께하는 순간을 특별하게 기억할 수 있어요**

- 예쁜 배경 속에서 대화하고 움직이는 우리들의 모습을 사진으로 기록해 보세요

<img src="https://user-images.githubusercontent.com/119986005/224272749-423563f6-d5d5-475e-b933-fd904708cca5.png" width="30" height="30"/> **캔버스**

- 화상방 안의 화이트보드와 캔버스 기능으로 그림을 그릴 수 있어요!

<img src="https://user-images.githubusercontent.com/119986005/224271625-8c9a99b6-039e-42bd-8c71-826037568228.png" width="30" height="30"/> **실시간 화상/텍스트 채팅**

- 화상방 안의 유저들끼리 실시간으로 의견을 나눌 수 있습니다. 또한 그림도 전송할 수 있습니다.

<img src="https://user-images.githubusercontent.com/119986005/224273437-950031b3-b1cd-43d6-993f-700255a618f1.png" width="30" height="30"/> **무한스크롤**

- 많은 방 목록을 최적화하여 랜더링하기 위해 무한스크롤을 도입하였습니다.

<img src="https://user-images.githubusercontent.com/119986005/224271886-3a443825-f581-4fb2-bd44-c7794b5f63fb.png" width="30" height="30"/> **소셜 로그인**

- 구글과 카카오, 네이버를 통한 소셜로그인으로 간편하게 로그인할 수 있습니다.

<img src="https://user-images.githubusercontent.com/119986005/224273225-25a85431-ea63-47ca-93e3-2ac44149474a.png" width="30" height="30"/> **검색**

- 방 검색이 가능합니다.

<br>   
   
## <img src="https://user-images.githubusercontent.com/119986005/224274600-db2b23d5-2e4a-46ce-832a-afb58c229b0d.png" width="40" height="40"/> 아키텍쳐

<img src="https://user-images.githubusercontent.com/119986005/224610115-d6affbd6-cd96-4a58-8d4b-ca29ac71fac1.png" width="100%" height="100%"/>

<br >

## <img src="https://user-images.githubusercontent.com/119986005/224275337-be28656e-be7b-49c2-b692-5ffd34aa268c.png" width="40" height="40"/> 기술스택

**Tech**

**Frontend**

<img src="https://img.shields.io/badge/React-61DAFB?style=for-the-badge&logo=React&logoColor=000000"> <img src="https://img.shields.io/badge/stomp-010101?style=for-the-badge&logo=&logoColor=white"> <img src="https://img.shields.io/badge/sockjs-010101?style=for-the-badge&logo=&logoColor=white"> <img src="https://img.shields.io/badge/JavaScript-F7DF1E?style=for-the-badge&logo=JavaScript&logoColor=white"> <img src="https://img.shields.io/badge/Axios-5A29E4?style=for-the-badge&logo=Axios&logoColor=white"> <img src="https://img.shields.io/badge/React Router-CA4245?style=for-the-badge&logo=React Router&logoColor=white"> <img src="https://img.shields.io/badge/Vercel-000000?style=for-the-badge&logo=Vercel&logoColor=white"> <img src="https://img.shields.io/badge/openvidu-412991?style=for-the-badge&logo=&logoColor=white">

<img src="https://img.shields.io/badge/styled-components-DB7093?style=for-the-badge&logo=styled-components&logoColor=white"> <img src="https://img.shields.io/badge/zustand-000000?style=for-the-badge&logo=&logoColor=white"> <img src="https://img.shields.io/badge/WebRTC-333333?style=for-the-badge&logo=WebRTC&logoColor=white"> <img src="https://img.shields.io/badge/MUI-007FFF?style=for-the-badge&logo=MUI&logoColor=white"> <img src="https://img.shields.io/badge/react-colorpalette-FF4154?style=for-the-badge&logo=&logoColor=white"> <img src="https://img.shields.io/badge/React Query-FF4154?style=for-the-badge&logo=React Query&logoColor=white"> <img src="https://img.shields.io/badge/HTML5-canvas-F68D2E?style=for-the-badge&logo=&logoColor=white"> <img src="https://img.shields.io/badge/Intersection Observer-3B7D1C?style=for-the-badge&logo=&logoColor=white">

**Backend**

<img src="https://img.shields.io/badge/SPRING BOOT-1DDB16?style=flat-square&logo=springboot&logoColor=white"/> <img src="https://img.shields.io/badge/SPRING SECURITY-1DDB16?style=flat-square&logo=springsecurity&logoColor=white"/> <img src="https://img.shields.io/badge/OAUTH2-000000?style=flat-square&logo=OAUTH2&logoColor=white"/> <img src="https://img.shields.io/badge/JWT-000000?style=flat-square&logo=JWT&logoColor=white"/> <img src="https://img.shields.io/badge/REDIS-FF0000?style=flat-square&logo=redis&logoColor=white"/> <img src="https://img.shields.io/badge/MYSQL-4374D9?style=flat-square&logo=mysql&logoColor=white"/> <img src="https://img.shields.io/badge/WEBRTC-000000?style=flat-square&logo=webrtc&logoColor=white"/>
<img src="https://img.shields.io/badge/AMAZON RDS-4374D9?style=flat-square&logo=amazonrds&logoColor=white"/>
<img src="https://img.shields.io/badge/AMAZON S3-ABF200?style=flat-square&logo=amazons3&logoColor=white"/>
<img src="https://img.shields.io/badge/AMAZON EC2-FFBB00?style=flat-square&logo=AMAZON EC2&logoColor=white"/>
<img src="https://img.shields.io/badge/DOCKER-2496ED?style=flat&logo=Docker&logoColor=white"/>
<img src="https://img.shields.io/badge/GITHUB-000000?style=flat&logo=GITHUB&logoColor=white"/>
<img src="https://img.shields.io/badge/GITHUB ACTIONS-0054FF?style=flat&logo=GITHUB ACTIONS&logoColor=white"/>
<img src="https://img.shields.io/badge/NGINX-1DDB16?style=flat&logo=NGINX&logoColor=white"/>
<img src="https://img.shields.io/badge/KURENTO-000000?style=flat&logo=KURENTO&logoColor=white"/>
<img src="https://img.shields.io/badge/OPENVIDU-1DDB16?style=flat&logo=OPENVIDU&logoColor=white"/>
<img src="https://img.shields.io/badge/SockJS-000000?style=flat-square&logo=SockJS&logoColor=white"/>
<img src="https://img.shields.io/badge/STOMP-000000?style=flat-square&logo=STOMP&logoColor=white"/>
<img src="https://img.shields.io/badge/AMAZON ROUTER 53-FFBB00?style=flat-square&logo=AMAZON ROUTER 53&logoColor=white"/>
<img src="https://img.shields.io/badge/HTTPS-FF5E00?style=flat-square&logo=HTTPS&logoColor=white"/>

**Design**

<img src="https://img.shields.io/badge/Figma-F24E1E?style=for-the-badge&logo=Figma&logoColor=white"> <img src="https://img.shields.io/badge/Adobe XD-FF61F6?style=for-the-badge&logo=Adobe XD&logoColor=white">

**Tools**

<img src="https://img.shields.io/badge/vscode-007FFF?style=for-the-badge&logo=&logoColor=white"> <img src="https://img.shields.io/badge/Git-F05032?style=for-the-badge&logo=Git&logoColor=white"> <img src="https://img.shields.io/badge/GitHub-181717?style=for-the-badge&logo=GitHub&logoColor=white"> <img src="https://img.shields.io/badge/Notion-000000?style=for-the-badge&logo=Notion&logoColor=white"> <img src="https://img.shields.io/badge/Slack-4A154B?style=for-the-badge&logo=Slack&logoColor=white">

<br>   
   
## <img src="https://user-images.githubusercontent.com/119986005/224276309-7a2bffbe-069f-4ccc-a89d-947cc39ead0b.png" width="40" height="40"/> 기술적 의사 결정

|       사용 기술       | 의사결정                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 결과                                                                                                                                                                                                                                                                                                                                                                                                                            |
| :-------------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|       Openvidu        | <div style="width:700px">프로젝트 초기, Openvidu를 사용하지 않고, WebRTC로만 구현을 시도했지만, 구현 난이도, 플랫폼 간 문제, 안정성 저하 등의 문제가 발생하여 이러한 문제들을 해결하고자Openvidu 사용.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <div style="width:700px">개발 속도가 올라감, 안정성이 향상됨, 프로젝트 초기 백엔드의 기본 코드 만으로도 프런트엔드에서 다대다 화상,음성 관련 코드 작성 및 테스트가 가능.</div>                                                                                                                                                                                                                                                  |
|     Redis (NoSql)     | <div style="width:700px">1. 애플리케이션이 실행되는 단일 서버에서만 채팅 메시지가 처리되는 문제가 있었음. 이를 해결하기 위해 Redis의 pub/sub을 사용하자는 의견이 나옴 <br/>2. 기존에 RDB로 Refresh Token을 관리해 왔지만, 모든 요청에서 토큰을 검사하고 Database에서 확인하므로, 오버헤드가 클 것으로 판단 + 리프레쉬 토큰의 유효기간이 지나면 스케줄러를 사용해야 하는 불편함이 있다.                                                                                                                                                                                                                                                                                                | <div style="width:700px">1. Redis의 pub/sub을 사용해서 다수의 서버가 채팅 메시지를 교환 할 수 있는 환경을 구축함.<br/>2-1. Redis 의 TimeToLive를 사용하여 삭제기간을 설정함 <br/>2-2. 많은 요청들을 Redis로 연결하여 오버헤드를 줄임.                                                                                                                                                                                           |
|     Refresh Token     | <div style="width:700px">기존 Access Token 하나 만을 사용 시, 서비스 사용자는 자주 로그인을 해야하므로 불편함을 겪고, 그렇다고 Access Token 만료기간을 늘리면 토큰 탈취 시 공격자가 오랜 시간 해당 계정을 사용할 수 있다는 단점이 있다. 그렇기 때문에, Refresh Token을 도입했고, Refresh Token Rotation(1회성 리프레쉬 토큰)을 사용해서, 엑세스 토큰이 만료 시 리프레쉬 토큰이 유효(기간도 유효)할 경우 엑세스, 리프레쉬 토큰 둘 다 재발급하여 Refresh Token이 2번 이상 사용 된다면 탈취됐다는 것을 확인할 수 있다. 또한 Database에서 Refersh Token을 삭제하면 해당 유저의 접근을 차단할 수 있고, 이러한 로직들로 인해 Database 오버헤드가 많이 생길 것으로 예상, Redis를 사용하였다. | 1. Access Token이 만료되더라도, Refresh Token으로 재발급 받으면서 로그인을 하여 사용자의 편리함 증가. <br/>2. Refresh Token으로 재발급 할때 AT, RT 둘 다 재발급 받으므로, Refresh Token은 1회성으로만 사용할 수 있고 2번 이상 사용된다면 탈취 됐다는 것을 가정할 수 있음. <br/>3. 또한 RT로 AT, RT 재발급 시 RT의 만료기간 자체도 계속 길어지므로 사용자의 자동 로그인 기간이 더 늘어난다. → 토큰이 계속 바뀌므로 보안성을 높임 |
|        logback        | <div style="width:700px">서버를 배포하고 나면 실시간으로 로그를 확인하지 못해 어디서 오류가 생겼는지 판단하기 어려웠음. 로그를 실시간으로 확인하기 위해서 logback을 사용해서 AWS CloudWatch에 저장을 하기로 결정함.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 1. logback을 사용해서 CloudWatch에 로그를 저장 가능함 <br/>2. CloudWatch를 통해 로그를 실시간으로 확인할 수 있게 되었음                                                                                                                                                                                                                                                                                                         |
|        Grafana        | <div style="width:700px">서버의 CPU 사용량이 높아 다운이 되었던 문제가 생겼었고, 이를 통해 모니터링의 필요성을 느끼게됨. 프로메테우스를 통해 메트릭 정보를 수집하고 그라파나를 이용해서 모니터링을 하자고 결정함                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 1. 트래픽, 메모리, CPU 사용량을 실시간으로 모니터링 할 수 있게 되었음.<br/>2. 알림 기능을 구현하여 메모리, CPU 사용량이 높을때 Slack으로 메시지가 갈 수 있도록 구현함.                                                                                                                                                                                                                                                          |
|        canvas         | <div style="width:700px">드로잉 기능을 구현하기 위해 canvas 또는 webGL을 선택할 수 있었고, canvas가 webGL에 비해 러닝 커브가 낮고, 비교적 간단하게 구현할 수 있다는 장점과 우리 서비스에서는 webGL의 3D기능은 불필요하므로 canvas를 선택함                                                                                                                                                                                                                                                                                                                                                                                                                                            | canvas의 간단한 사용 방법 덕분에 짧은 기간내에 서비스에서 목표로 하는 드로잉 기능 구현을 구현함                                                                                                                                                                                                                                                                                                                                 |
|        zustand        | <div style="width:700px">리액트 상태관리를 위해 보편적으로 많이 사용되는 redux의 보일러플레이트 이슈로 인해 더 간결한 방식인 zustand를 도입함                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | redux의 보일러플레이트 이슈 없이 간결한 코드로 상태관리가 가능해져 개발과 유지보수 등 작업 효율성이 증가함                                                                                                                                                                                                                                                                                                                      |
|         axios         | <div style="width:700px">비동기로 HTTP통신을 하기 위해 브라우저 호환성이 높은 AXIOS를 선택함                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 크롬, 파이어폭스, 엣지 등 다양한 브라우저에서 서버통신 기능들이 정상 작동하고, Promise 기반으로 만들어졌기 때문에 원하는 방식으로 데이터 처리 작업이 가능해짐                                                                                                                                                                                                                                                                   |
|   styled-components   | <div style="width:700px">모듈성을 위한 css 모델을 문서레벨이 아닌 컴포넌트 레벨로 추상화 한다는 점과 js와 css 사이의 상수와 함수를 쉽게 공유할 수 있고 props를 활용한 조건부 스타일링이 가능하다는 장점이 이번 서비스에 적합하다고 판단하여 도입함                                                                                                                                                                                                                                                                                                                                                                                                                                    | 모듈화와 조건부 스타일링 덕분에 컴포넌트 재활용성이 증가하였고 하나의 컴포넌트로 다양한 처리가 가능해짐                                                                                                                                                                                                                                                                                                                         |
|   React-router-dom    | <div style="width:700px">component 구조 덕분에 부분적 변화를 효율적으로 반영 할 수 있다는 리액트의 장점을 극대화 할 수 있다는 점에서 도입함                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 컴포넌트 업데이트를 통하여 새로고침을 하지 않고 페이지 이동이 가능해져 유저 입장에서 쾌적한 서비스 이용이 가능해짐                                                                                                                                                                                                                                                                                                              |
| Intersection-observer | <div style="width:700px">브라우저 뷰포트(Viewport)와 설정한 요소(Element)의 교차점을 관찰하며, 사용자의 현재 화면에 타겟 요소가 보이는지를 판단하는 것을 기준으로 비동기로 작동하기 때문에 scroll 같은 이벤트 기반의 요소 관찰에서 발생하는 렌더링 성능이나 이벤트 연속 호출 같은 문제 없이 사용 가능하다는 점에서 도입함                                                                                                                                                                                                                                                                                                                                                             | 성능적으로 효율적이고 비동기적으로 작동하는 라이브러리의 특성상 랜더링 이슈 없이 무한 스크롤링이 가능해짐                                                                                                                                                                                                                                                                                                                       |

<br />

## <img src="https://user-images.githubusercontent.com/119986005/224276307-a28461c6-d908-4454-ae1a-aef16801a522.png" width="40" height="40"/> 트러블 슈팅

<br />

**Backend**

<details><summary> Web RTC
</summary>

`발생 문제`

Pear To Pear WebRTC 연결에는 쉽게 성공했지만,
M:N 화상 채팅이 안 됨.

`해결 방안`

- Signaling Server
- Media Sever
- Turn(Stun)Server
- Kurento Media Server

위와 같은 서버 등을 구축할 필요성을 느끼고 하나의 서버에 구축함. → 성공

`Kurento Media Server는 Ubuntu 18버전까지만 지원한다고 한다.`

`추가 문제 발생`

- 아이폰에서 화면이 안 보이는 등, 플랫폼 간 이슈
- 사용자가 3~4명 이상 들어오면 끊기는 등 안정성이 떨어짐
- 프런트엔드 백엔드 구현 난이도가 올라감 → 개발 시간이 올라감

`해결 방안`

그리하여, 프론트와의 소통결과 Openvidu로 하는 게 편의성, 안정성 면에서 좋을 것 같아, Openvidu로 변경함.

</details>

<details><summary>Openvidu 502
</summary>

`문제 발생`

- ec2 서버에서 443포트에 openvidu app을 열어놓고 ./openvidu start 실행
- 443으로 접속 시 502 발생.
- `sudo lsof -i :443` 확인 시 nginx의 포트 리스닝 설정이 떠야 하지만 아무것도 열려있지 않은 상태….

`예상 문제`

1. nginx 문제 → docker 문제?
2. 로드밸런서 문제는 아니다. 기존 잘 되던 설정에서 대상그룹만 바꿔 그대로 사용했다.
3. CERTIFICATE_TYPE 문제?

`시도 → 해결`

1. docker 설치 시 세세한 부분에서 에러 로그가 찍히는 게 확인되어서
   1. 새로운 명령어를 찾아 docker를 설치하였다.
2. 기존에 letsencrypt 형식의 방식을
   1. 생각해 보니 서버 자체에 https를 쓰고 있어서 안 써도 될 것 같다고 판단
   2. selfsigned 형식을 사용하고 80포트를 닫았다.

서버를 새로 생성하고 위의 1, 2를 진행하고 해보니 바로 동작이 됐다….

```java
sudo vi .env

#######################################################
DOMAIN_OR_PUBLIC_IP=abcd.shop
OPENVIDU_SECRET=MY_SECRET
CERTIFICATE_TYPE=selfsigned # 서버에 https가 적용되어 있으므로.
LETSENCRYPT_EMAIL=user@example.com
#HTTP_PORT=80
HTTPS_PORT=443
```

</details>

<details><summary>Spring Securty OAuth + JWT
</summary>

`문제 발생`

기존 Spring Security 로그인을 생각하고 진행하다 보니,

- 현재 서비스는 회원 가입이없고, 소셜 로그인만 존재하는 형태.
- 소셜 로그인 시에, 유저정보를 불러와 다음 로직이 진행 가능하지만
  - JWT로 로그인 시에는 해당 소셜로그인 정보를 어떻게 불러 올지 구현하는게 까다로웠다.
    - Security에서 제공하는 `oauth2Login()`를 사용했기에 기존에 구현해봤던 로직이랑 조금 많이 달랐다.

`이유 및 해결 과정`

기본적으로 아래처럼 OAuth2Login()의 경우 로그인에 성공하면 OAuth2User형태로 관리되어서,

| Security Login(일반 회원) | Security OAuth2 Login(소셜 회원)2 |
| ------------------------- | --------------------------------- |
| UserDetails               | OAuth2User                        |

컨트롤러 단에서 `@AuthenticationPrincipal UserDetails authentication`과 같이 사용하지 못함. → NPE

게다가 `userDetailsService`의 `loadByUsername`은 username을 기반으로
db에서 user를 조회해 와서, User의 정보가 담긴 `UserDetails`를 return 하기 때문에 크게 문제가 없지만

OAuth2 로그인의 경우 `OAuth2UserService`의 `loadUser`는 소셜 로그인을 할 때 `OAuth2UserRequest`를 기준으로 요청 기준으로 해당 소셜 서버에서 정보를 바로 빼와서 `DefaultOAuth2User`를 return 한다.

그래서, 아래처럼 어노테이션과 loadUserPrincipal을 직접 만들어서 구현했다.

</details>

<details><summary> 실시간 채팅 이미지 전송 트러블 슈팅
</summary>

문제점

- socket을 통해 이미지를 보낼때 binary 메세지의 형태로 송수신하면 3mb가 넘어갔을때 socket 연결이 끊기는 문제가 있었다.

해결방법

- 프론트에서 binary 메세지 - > byte code로 변환

1. Byte Code를 다시 바이트 배열로 바꿔준다.

1. 임시 이미지 파일을 하나 생성
1. 임시 이미지 파일의 스트림을 열어서 바이트 배열을 작성하고 저장한다.

- byte code를 백엔드에서 다시 File로 변환해서 저장

1. 임시 이미지 파일을 s3에 저장.
2. 임시 이미지 파일 스트림 닫기 & 삭제

```java
@Transactional
public RoomFileMessage BinaryImageChange(ChatMessageRequestDto chatMessageRequestDto) {
    RoomFileMessage roomFileMessage;
    try {
        log.info("바이너리 이미지");
        String[] strings = chatMessageRequestDto.getImgByteCode().split(",");
        String base64Image = strings[1];

        String extension = strings[0].split(";")[0].split("/")[1];

        byte[] imageBytes = javax.xml.bind.DatatypeConverter.parseBase64Binary(base64Image);

        File tempFile = File.createTempFile("image", "." + extension);
        try (OutputStream outputStream = new FileOutputStream(tempFile)) {
            outputStream.write(imageBytes);
        }

        String awsS3ImageUrl = awsService.S3FileImageUpload(tempFile);

        roomFileMessage = new RoomFileMessage(chatMessageRequestDto, awsS3ImageUrl);

        return roomFileMessage;
    } catch (IOException ex) {
        log.error("IOException Error Message : {}",ex.getMessage());
        ex.printStackTrace();
    }
    throw new CustomErrorException(HttpStatus.OK, 200, "이미지 파일이 생성되지 않았습니다");
}
```

결과

- 30mb까지 저장할 수 있게 되었다.
</details>
<br />

**Frontend**

<details><summary>실시간 채팅 이미지 미리보기 삭제
</summary>

문제점

미리보기 중 x 버튼을 눌러도 데이터가 남아서 전송버튼 이벤트 발생 시 유저 눈에 안 보이는 사진 데이터가 전송되는 문제가 발생

해결방법

```
<StImg>
<TiDeleteOutline onClick={handleImageRemove} className="cross" size="small" />
<img src={image} />
</StImg>
```

이미지에 x가 달리는 부분에 remove 이벤트를 추가

```
const handleImageRemove = () => {
setImage(null);
imgRef.current.value = null;
};
```

이벤트 발생 시 setImage를 null 값으로 바꿔주고 input창도 null로 비워줌

</details>

<details><summary> 실시간 채팅 도배문제
</summary>

문제점

메세지를 보낸 후 아무런 제약 없이메세지를 다시 보낼 수 있어서 채팅방에 도배 메세지가 가득해지면
웹 소켓이 끊어져 버리는 문제가 발생

해결방법

데이터를 보낸 후 시간제한을 걸어 바로바로 메세지 전송이 안 되게 프론트 코드로 제한함

```
  <Click ref={sendButtonRef} onClick={sendChat}>
          전송
        </Click>
```

버튼에 ref로 이벤트 발생을 체크하고

```
 if (sendButtonRef.current.disabled) {
      // 전송 버튼이 이미 비활성화된 경우
      return;
    } else if (msg === "" && !img) {
      // 메시지와 이미지가 모두 없는 경우
      sendButtonRef.current.disabled = false; // 전송 버튼을 다시 활성화
      return;
    }
    // 메시지나 이미지가 있을 때
    sendButtonRef.current.disabled = true;
    sendButtonRef.current.innerText = "ing...";
```

버튼의 이벤트 발생을 체크해서 활성화/ 비활성화시켜준다.
전송 이벤트가 발생하면 내부 text를 진행 중으로 바꿔주고

```
setTimeout(() => {
      sendButtonRef.current.disabled = false;
      sendButtonRef.current.innerText = "전송"; // 버튼 텍스트 변경
    }, 1000);
```

제한해둔 시간이 지나면 전송으로 바꿔 채팅이 다시 가능하게 제한을 했다.

</details>

<details><summary> 실시간 채팅 데이터 두 번 찍히는 문제
</summary>

문제점

화상채팅방 안에서 새로고침 이벤트가 발생하면 유저 채팅이 2-3개로 증가해서 보이는 문제 발생

해결방안
zustand로 처리하는 데이터가 문제가 생겼다 가정
받아오는 데이터를 console.log로 확인해보니 새로고침 등의 이벤트가 발생하면 id가 같은 데이터를 2개 이상 받아오는 문제가 생김을 발견

```
 const seenMessageIdsObj = {};
  const seenFileIdsObj = {};
  const filteredMessages = [];

  message.forEach((msg) => {
    const messageId = msg.receive.messageId;
    const fileId = msg.receive.fileId;

    if (messageId !== null && seenMessageIdsObj[messageId]) {
      // messageId가 이미 중복된 경우
      return;
    } else if (fileId !== null && seenFileIdsObj[fileId]) {
      // fileId가 이미 중복된 경우
      return;
    } else {
      // 중복이 없는 경우
      filteredMessages.push(msg);
      seenMessageIdsObj[messageId] = true;
      seenFileIdsObj[fileId] = true;
    }
  });
```

문제가 있는 배열을 다시 순환하면서 체크하고 중복된 id를 가진 데이터는 한 개만 배열에 넣을 수 있도록 수정
중복되지 않은 id를 가진 데이터는 그대로 배열에 넣고 그렇게 만들어진 새로운 배열을 가지고 map을 돌리도록 코드를 수정

```
filteredMessages.slice(0).reverse() .map((chating) =>
 chating.receive.name === name ? (
<SendMessage key={chating.receive.messageId || chating.receive.fileId}>
```

</details>

<details><summary> webRTC - openvidu
</summary>

1. 참여자가 모두 퇴장할 경우 마지막 퇴장 인원의 이력이 남아 있는 문제

   > 참여자의 세션이 모두 끊기고 참여자 목록의 값이 0일 경우, 참여자 목록을 모두 비우는 코드를 작성해서 해결

2. vercel 배포 오류, "node version 18” "npm run build exited with 1” > node 버전을 안정적인 16버전으로 낮추는 코드 작성 후 해결 - package.json
<img src="https://user-images.githubusercontent.com/119986005/224381859-57b19fcc-7df2-401a-94e3-71bb54eeb3ca.png" width="100%" height="100%"/>
</details>

<details><summary> display Capture
</summary>

html2canvas > css가 깨진 상태로 캡쳐되는 현상

1. 사이즈 깨짐 이슈 -캡쳐될 div의 기본 사이즈가 필수로 지정되어 있어야 해당 사이즈로 캡쳐됨
   -min-width가 아니라 width로 기본 사이즈 지정으로 해결
2. css 깨짐 이슈 -해당 라이브러리에서 지원되지 않는 box-shadow 사용으로 인한 이슈 -캡쳐되는 순간 box-shadow를 none으로 변경하는 방법으로 해결
</details>

<details><summary> delete api
</summary>

페이지가 unload될 때 서버에 요청한, 방 나가기 api가 제대로 작동하지 않는 이슈

1. api 요청 속도가 unload 속도보다 느려서 요청 중 종료됨
2. 페이지 unload 시 분석 데이터 전송 등
   요청만을 위해 사용하는 Web api Navigator.sendBeacon 사용으로 해결

 <img src="https://user-images.githubusercontent.com/119986005/224388333-ab1a459a-9d32-437b-8611-94bfca7776c6.png" width="100%" height="100%"/>
<br />
<img src="https://user-images.githubusercontent.com/119986005/224381851-dfe4b050-376d-4bbf-b667-1360150774ff.png" width="100%" height="100%"/>

</details>

<br>

## <img src="https://user-images.githubusercontent.com/119986005/224307043-6b1600d2-5a59-45cc-8704-88a371361f4d.png" width="40" height="40"/> 아이콘 's

<details><summary><u>README 사용된 아이콘의 출처입니다.</u>
</summary>

<a href="https://www.flaticon.com/kr/free-icons/" title="혁신 아이콘">혁신 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="게시 아이콘">게시 아이콘 제작자: Freepik - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="친구 아이콘">친구 아이콘 제작자: Flat Icons - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="일상 아이콘">일상 아이콘 제작자: Freepik - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="특색 아이콘">특색 아이콘 제작자: Muhammad Ali - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="커스텀 아이콘">커스텀 아이콘 제작자: Muhammad Ali - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="웹 디자인 아이콘">웹 디자인 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="사진술 아이콘">사진술 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="비즈니스 및 금융 아이콘">비즈니스 및 금융 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="통신 아이콘">통신 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="디지털 플랫폼 아이콘">디지털 플랫폼 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="현서와 웹 아이콘">현서와 웹 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="예술과 디자인 아이콘">예술과 디자인 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="발견하다 아이콘">발견하다 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="마법의 주문 아이콘">마법의 주문 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="메가폰 아이콘">메가폰 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="분자 아이콘">분자 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="데이터 공유 아이콘">데이터 공유 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/-" title="온라인 도서관 아이콘">온라인 도서관 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="불꽃 아이콘">불꽃 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="프로모션 아이콘">프로모션 아이콘 제작자: Talha Dogar - Flaticon</a>

<a href="https://www.flaticon.com/kr/free-icons/" title="라이브 아이콘">라이브 아이콘 제작자: srip - Flaticon</a>

</details>

<br>
